<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monad Strategy Dashboard</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 24px; }
      h1 { margin-bottom: 4px; }
      section { margin-top: 20px; }
      pre { background: #f7f7f7; padding: 12px; overflow: auto; white-space: pre-wrap; }
      #runResult { max-height: 240px; overflow: auto; }
      input, textarea { width: 100%; margin-top: 6px; }
      button { margin-top: 8px; }
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; }
      #paramFields div { margin-bottom: 8px; }
      .status-ok { color: #2e7d32; }
      .status-error { color: #c62828; }
      .row-execute { color: #2e7d32; }
      .row-simulated { color: #1565c0; }
      .row-planned { color: #6a1b9a; }
      #executionSummaryList .selected { background: #e3f2fd; border-left: 4px solid #64b5f6; padding-left: 6px; }
      .summary-copy-hint { font-size: 11px; color: #888; margin-left: 6px; }
      .badge { display: inline-block; padding: 1px 6px; border-radius: 10px; font-size: 11px; color: #fff; }
      .badge-status-execute { background: #2e7d32; }
      .badge-status-simulated { background: #1565c0; }
      .badge-status-planned { background: #6a1b9a; }
      .badge-mode-execute { background: #1b5e20; }
      .badge-mode-simulate { background: #0d47a1; }
      .badge-mode-plan { background: #4a148c; }
      .api-label { font-size: 12px; padding: 2px 6px; border-radius: 8px; margin-left: 6px; }
      .api-node { background: #e3f2fd; color: #0d47a1; }
      .api-fastapi { background: #e8f5e9; color: #1b5e20; }
      .api-custom { background: #fff3e0; color: #e65100; }
      .refresh-active { color: #1b5e20; }
      .refresh-paused { color: #e65100; }
      .refresh-disabled { color: #6d6d6d; }
      .highlight-copy { background: #fff9c4; }
      .highlight-refresh { background: #e3f2fd; }
      .api-divider { border-top: 1px solid #ddd; margin: 8px 0; }
      .api-advanced-button {
        background: #f5f5f5;
        border: 1px solid #ddd;
        padding: 4px 8px;
        font-size: 12px;
        cursor: pointer;
      }
      .api-choice-active {
        border: 1px solid #4caf50;
        background: #e8f5e9;
      }
      #apiBaseUrl::placeholder { color: #aaa; }
    </style>
  </head>
  <body>
    <h1>Monad Strategy Dashboard</h1>
    <p>Minimal strategy list + execution log viewer.</p>

    <section>
      <h2>API Settings</h2>
      <button id="apiSettingsToggle" onclick="toggleApiSettings()">Hide API Settings</button>
      <span id="apiSettingsStatus" style="font-size: 12px; color: #666;" title=""></span>
      <div id="apiBaseControls">
      <label>API Base URL</label>
      <input id="apiBaseUrl" placeholder="http://127.0.0.1:8000" style="max-width: 360px;" ondblclick="copyApiBaseUrl()" oninput="validateApiBaseUrl()" onchange="autoSaveApiBaseUrl()" onblur="autoSaveApiBaseUrl()" list="apiBaseHistory" />
      <datalist id="apiBaseHistory"></datalist>
      <button onclick="saveApiBaseUrl()">Save</button>
      <button onclick="clearApiBaseUrl()">Clear</button>
      <button onclick="testApiBaseUrl()">Test</button>
      <button onclick="copyApiBaseUrl()">Copy URL</button>
      <button id="apiUseNode" onclick="setApiBaseUrl('http://127.0.0.1:4173')" title="Alt+N">Use Node</button>
      <button id="apiUseFast" onclick="setApiBaseUrl('http://127.0.0.1:8000')" title="Alt+F">Use FastAPI</button>
      <button onclick="resetApiBaseUrlConfirm()">Reset Default</button>
      <span id="apiBaseHint" style="font-size: 12px; color: #666;"></span>
      <span id="apiBaseCurrent" style="font-size: 12px; color: #666; cursor: pointer;" onclick="copyApiBaseCurrent()" title="Click to copy"></span>
      <button onclick="clearApiBaseHistoryConfirm()">Clear history</button>
      <span id="apiKeyHint" style="font-size: 12px; color: #666;">Alt+N / Alt+F</span>
      <span id="apiBaseType" class="api-label"></span>
      </div>
      <div class="api-divider" id="apiAdvancedDivider"></div>
      <button id="apiAdvancedHint" class="api-advanced-button" onclick="expandApiSettings()"></button>
      <div id="apiSettingsPanel">
      <div id="apiRefreshControls">
      <button onclick="refreshApiInfo()">Refresh API Info</button>
      <button onclick="copyApiHealth()">Copy Health</button>
      <span id="apiHealthUpdated" style="font-size: 12px; color: #666;"></span>
      <span id="apiRefreshCountdown" style="font-size: 12px; color: #666; display: none; cursor: pointer;" title="Click to refresh now" onclick="manualApiRefresh()" onmouseenter="updateRefreshCountdownCursor()"></span>
      <label><input type="checkbox" id="apiAutoRefresh" onchange="toggleApiAutoRefresh()" /> Auto refresh</label>
      <label>Interval(s)</label>
      <input id="apiRefreshInterval" type="number" min="1" value="5" onchange="persistApiRefreshInterval()" onkeydown="if(event.key==='Enter'){persistApiRefreshInterval();}" />
      <button id="apiRefreshPause" onclick="toggleApiAutoPause()">Pause</button>
      <span id="apiRefreshStatus" style="font-size: 12px; color: #666;"></span>
      <span id="apiRefreshHint" style="font-size: 12px; color: #666;"></span>
      <span id="apiRefreshIntervalDisplay" style="font-size: 12px; color: #666; display: none;"></span>
      <span id="apiHealthErrors" style="font-size: 12px; color: #c62828;"></span>
      <button onclick="clearApiHealthErrors()">Hide errors</button>
      <button onclick="toggleApiHealthErrorsDetail()">Toggle error details</button>
      <label><input type="checkbox" id="apiHealthErrorsDefault" onchange="persistApiHealthErrorsDefault()" /> Collapse by default</label>
      <button id="apiHealthErrorsCopy" onclick="copyApiHealthErrorsDetail()" title="Copy error details">Copy error details</button>
      <span id="apiHealthErrorsStatus" style="font-size: 12px; color: #666;"></span>
      <pre id="apiHealthErrorsDetail" style="display: none;"></pre>
      <span id="apiHealthLastError" style="font-size: 12px; color: #c62828;"></span>
      <button onclick="copyApiHealthLastError()">Copy last error</button>
      <button onclick="clearApiHealthLastError()">Clear last error</button>
      <span id="apiVersion" style="font-size: 12px; color: #666; cursor: pointer;" onclick="copyApiVersion()"></span>
      <span id="apiBuild" style="font-size: 12px; color: #666;"></span>
      <span id="apiInstance" style="font-size: 12px; color: #666;"></span>
      <span id="apiUptime" style="font-size: 12px; color: #666;" title=""></span>
      <span id="apiStartedAt" style="font-size: 12px; color: #666;" title=""></span>
      </div>
      </div>
    </section>

    <section>
      <h2>Create Strategy (NL â†’ Template)</h2>
      <label>Intent Text</label>
      <textarea id="intentText" rows="3" placeholder="Swap 10 USDC to MON"></textarea>
      <label>Template (optional)</label>
      <select id="templateSelect" onchange="selectTemplate(this.value)"></select>
      <input id="template" placeholder="swap-v1" />
      <button onclick="loadLastStrategyParams()">Load Last Params</button>
      <label>Template Parameters (auto)</label>
      <div id="templateInfo"></div>
      <div id="optionalInfo"></div>
      <button onclick="toggleOptionalParams()">Toggle Optional Params</button>
      <button onclick="clearParamFields()">Clear Params</button>
      <div id="paramFields"></div>
      <div id="paramHints"></div>
      <button onclick="fillParamExamples()">Fill Example Params</button>
      <label>Params JSON (optional)</label>
      <textarea id="params" rows="4" placeholder='{"router":"0x...","tokenIn":"0x..."}'></textarea>
      <button onclick="formatParamsJson()">Format Params JSON</button>
      <button onclick="clearParamsJson()">Clear Params JSON</button>
      <div style="font-size: 12px; color: #666;">Paste JSON then use it to override auto fields.</div>
      <label>Risk (maxPerRunUsd, cooldownSeconds)</label>
      <textarea id="risk" rows="2" placeholder='{"maxPerRunUsd":100,"cooldownSeconds":300}'></textarea>
      <button onclick="formatRiskJson()">Format Risk JSON</button>
      <button onclick="saveRiskTemplate()">Save Risk</button>
      <button onclick="loadRiskTemplate()">Load Risk</button>
      <label><input type="checkbox" id="autoSaveRisk" checked /> Auto-save Risk</label>
      <button onclick="createStrategy()">Create</button>
      <button onclick="saveFormSnapshot()">Save Snapshot</button>
      <button onclick="loadFormSnapshot()">Load Snapshot</button>
      <button onclick="resetCreateForm()">Reset Form</button>
      <pre id="createResult"></pre>
    </section>

    <section>
      <h2>Run Strategy</h2>
      <label>Strategy ID</label>
      <input id="runStrategyId" placeholder="strat_..." />
      <button onclick="fillLatestStrategyId()">Use Latest Strategy</button>
      <label>Mode (plan/simulate/execute)</label>
      <input id="runMode" placeholder="plan" value="plan" />
      <label>Evidence JSON (optional)</label>
      <textarea id="runEvidence" rows="3" placeholder='{"routeId":"...","txHash":"..."}' onkeydown="if(event.ctrlKey && event.key==='Enter'){runStrategyNow();}"></textarea>
      <button onclick="fillEvidenceTemplate()">Fill Evidence Template</button>
      <button onclick="saveRunEvidence()">Save Run Evidence</button>
      <button onclick="loadRunEvidence()">Load Run Evidence</button>
      <button onclick="clearEvidence()">Clear Evidence</button>
      <span id="runEvidenceSaved" style="font-size: 12px; color: #666;"></span>
      <label>LI.FI Result JSON (optional)</label>
      <textarea id="runLifi" rows="3" placeholder='{"routeId":"...","tool":"...","estimateGas":"...","txHash":"..."}' onkeydown="if(event.ctrlKey && event.key==='Enter'){runStrategyNow();}"></textarea>
      <button onclick="fillLifiTemplate()">Fill LI.FI Template</button>
      <button onclick="saveRunLifi()">Save Run LIFI</button>
      <button onclick="loadRunLifi()">Load Run LIFI</button>
      <button onclick="clearLifiResult()">Clear LI.FI Result</button>
      <span id="runLifiSaved" style="font-size: 12px; color: #666;"></span>
      <button onclick="clearRunInputs()">Clear Run Inputs</button>
      <button onclick="clearRunInputsConfirm()">Clear Run Inputs (Confirm)</button>
      <button onclick="saveEvidenceTemplate()">Save Evidence Template</button>
      <button onclick="loadEvidenceTemplate()">Load Evidence Template</button>
      <button onclick="runStrategyNow()">Run</button>
      <button onclick="copyRunResult()">Copy Run Result</button>
      <button onclick="clearRunResultConfirm()">Clear Result</button>
      <label><input type="checkbox" id="keepRunResult" onchange="persistKeepRunResult()" /> Keep Result</label>
      <span style="font-size: 12px; color: #666;">Ctrl+Enter to run</span>
      <span id="runResultCopyHint" style="font-size: 12px; color: #666;"></span>
      <pre id="runResult"></pre>
    </section>

    <section>
      <h2>Execution Detail</h2>
      <label>Run ID</label>
      <input id="detailRunId" placeholder="run_..." />
      <button onclick="loadExecutionDetail()">Load Detail</button>
      <button onclick="copyExecutionField('runId')">Copy Run ID</button>
      <button onclick="copyExecutionField('txHash')">Copy Tx Hash</button>
      <button onclick="copyExecutionField('evidence')">Copy Evidence</button>
      <button onclick="copyExecutionField('payload')">Copy Payload</button>
      <button onclick="copyExecutionField('all')">Copy Full Detail</button>
      <button onclick="copyExecutionHighlights()">Copy Highlights</button>
      <button onclick="copyExecutionField('runId')">Copy Run ID</button>
      <button onclick="copyExecutionField('txHash')">Copy Tx Hash</button>
      <button onclick="copyHighlightField('routeId')">Copy Route</button>
      <button onclick="copyHighlightField('status')">Copy Status</button>
      <button onclick="copyHighlightField('mode')">Copy Mode</button>
      <button id="toggleHighlightsBtn" onclick="toggleExecutionHighlights()">Toggle Highlights</button>
      <label><input type="checkbox" id="executionHighlightsDefault" onchange="persistExecutionHighlightsDefault()" /> Collapse by default</label>
      <span style="font-size: 12px; color: #666;">Default collapse hides highlights on load.</span>
      <span id="highlightCopyHint" style="font-size: 12px; color: #666;"></span>
      <pre id="executionDetail"></pre>
      <pre id="executionDetailHighlights" title="runId: execution id; txHash: transaction hash; routeId: LI.FI route id; status/mode: execution state"></pre>
    </section>

    <div class="grid">
      <section>
        <h2>Strategies</h2>
        <button onclick="loadStrategies()">Refresh</button>
        <pre id="strategyList"></pre>
      </section>

      <section>
        <h2>Templates</h2>
        <button onclick="loadTemplates()">Refresh</button>
        <pre id="templateList"></pre>
      </section>

      <section>
        <h2>Executions</h2>
        <button onclick="loadExecutions()">Refresh</button>
        <pre id="executionList"></pre>
      </section>

      <section>
        <h2>Execution Summary (click runId)</h2>
        <label>Filter Status</label>
        <input id="summaryStatus" placeholder="planned/simulated/execute" />
        <button onclick="quickFilter('status','planned')">Planned</button>
        <button onclick="quickFilter('status','simulated')">Simulated</button>
        <button onclick="quickFilter('status','execute')">Executed</button>
        <label>Filter Mode</label>
        <input id="summaryMode" placeholder="plan/simulate/execute" />
        <button onclick="quickFilter('mode','plan')">Plan</button>
        <button onclick="quickFilter('mode','simulate')">Simulate</button>
        <button onclick="quickFilter('mode','execute')">Execute</button>
        <label>Search (runId/strategyId)</label>
        <input id="summarySearch" placeholder="run_..." />
        <label><input type="checkbox" id="summaryFields" checked /> Show extra fields</label>
        <label><input type="checkbox" id="summaryShowTime" checked /> Show time</label>
        <label><input type="checkbox" id="summaryShortTime" checked /> Short time</label>
        <label><input type="checkbox" id="summaryShowRoute" checked /> Show route</label>
        <label><input type="checkbox" id="summaryShowTx" checked /> Show tx</label>
        <label><input type="checkbox" id="summaryCompact" /> Compact view</label>
        <label><input type="checkbox" id="summarySortTime" checked /> Sort by time</label>
        <button onclick="loadExecutions()">Refresh</button>
        <button onclick="clearSummaryFilters()">Clear Filters</button>
        <button onclick="loadMoreExecutions()">Load More</button>
        <button onclick="exportSummary()">Export JSON</button>
        <button onclick="exportSummaryCsv()">Export CSV</button>
        <button onclick="copySummaryJson()">Copy Summary JSON</button>
        <button onclick="copySummaryCsv()">Copy Summary CSV</button>
        <button onclick="copySelectedSummaryRow()">Copy Selected Row</button>
        <button onclick="toggleSummaryJson()">Toggle Summary JSON</button>
        <button onclick="toggleSummaryList()">Toggle Summary List</button>
        <span id="summaryCopyHint" style="font-size: 12px; color: #666;"></span>
      <span id="summaryRowCopyHint" style="font-size: 12px; color: #666;"></span>
        <div id="executionSummaryList"></div>
        <pre id="executionSummary"></pre>
      </section>

      <section>
        <h2>Execution Evidence</h2>
        <button onclick="loadExecutions()">Refresh</button>
        <pre id="executionEvidence"></pre>
      </section>
    </div>

    <script>
      document.addEventListener("keydown", (event) => {
        if (event.altKey && event.key.toLowerCase() === "n") {
          setApiBaseUrl("http://127.0.0.1:4173");
        }
        if (event.altKey && event.key.toLowerCase() === "f") {
          setApiBaseUrl("http://127.0.0.1:8000");
        }
      });

      let templateCache = [];
      let summaryLimit = 10;
      let apiRefreshTimer = null;
      let apiRefreshCountdownTimer = null;
      let apiNextRefreshAt = null;
      let apiRefreshPaused = false;
      let apiRefreshPausedAt = null;
      let apiPausedRemaining = null;

      function getApiBaseUrl() {
        return (localStorage.getItem("apiBaseUrl") || "").replace(/\/$/, "");
      }

      function buildApiUrl(path) {
        const base = getApiBaseUrl();
        return base ? `${base}${path}` : path;
      }

      function apiFetch(path, options) {
        return fetch(buildApiUrl(path), options);
      }

      function saveApiBaseUrl() {
        const input = document.getElementById("apiBaseUrl");
        const value = input.value.trim();
        if (value && !validateApiBaseUrl()) {
          setHint("apiBaseHint", "Invalid URL");
          return false;
        }
        if (value) {
          const normalized = value.replace(/\/$/, "");
          localStorage.setItem("apiBaseUrl", normalized);
          setHint("apiBaseHint", "Saved");
          setApiBaseTypeLabel();
          refreshApiInfo();
          setApiBaseCurrent(normalized);
          updateApiBaseHistory(normalized);
          return true;
        }
        return false;
      }

      function autoSaveApiBaseUrl() {
        if (!saveApiBaseUrl()) {
          setHint("apiBaseHint", "Auto-save failed");
        } else {
          setHint("apiBaseHint", "Saved");
        }
      }

      function setApiBaseUrl(value) {
        const normalized = value.replace(/\/$/, "");
        const input = document.getElementById("apiBaseUrl");
        localStorage.setItem("apiBaseUrl", normalized);
        input.value = normalized;
        input.focus();
        setHint("apiBaseHint", `Using ${normalized}`);
        setApiBaseTypeLabel();
        refreshApiInfo();
        setApiBaseCurrent(normalized);
        updateApiBaseHistory(normalized);
      }

      function copyApiBaseUrl() {
        const input = document.getElementById("apiBaseUrl");
        const value = input.value.trim();
        if (!value) return;
        navigator.clipboard
          .writeText(value)
          .then(() => {
            setHint("apiBaseHint", "URL copied");
            input.select();
            input.classList.add("highlight-copy");
            setTimeout(() => input.classList.remove("highlight-copy"), 800);
          })
          .catch(() => setHint("apiBaseHint", "Copy failed"));
      }

      function resetApiBaseUrl() {
        document.getElementById("apiBaseUrl").value = "";
        localStorage.removeItem("apiBaseUrl");
        setApiBaseTypeLabel();
        setApiVersionLabel("");
        setHint("apiBaseHint", "Reset to default (Node)");
      }

      function resetApiBaseUrlConfirm() {
        if (confirm("Reset API base URL to default (Node)?")) {
          resetApiBaseUrl();
        }
      }

      function clearApiBaseUrl() {
        localStorage.removeItem("apiBaseUrl");
        document.getElementById("apiBaseUrl").value = "";
        setHint("apiBaseHint", "Cleared");
        setApiBaseTypeLabel();
        setApiVersionLabel("");
      }

      function loadApiBaseUrl() {
        const value = getApiBaseUrl();
        if (value) document.getElementById("apiBaseUrl").value = value;
        setApiBaseTypeLabel();
      }

      async function testApiBaseUrl() {
        const base = getApiBaseUrl();
        if (!base) {
          setHint("apiBaseHint", "Set base URL first");
          return;
        }
        try {
          const res = await fetch(`${base}/health`);
          const data = await res.json();
          if (data.status === "ok") {
            setHint("apiBaseHint", "API ok");
            setApiVersionLabel(data.version || "");
          } else {
            setHint("apiBaseHint", "API error");
          }
        } catch (error) {
          setHint("apiBaseHint", "API unreachable");
        }
      }

      function setApiVersionLabel(version) {
        const label = document.getElementById("apiVersion");
        label.textContent = version ? `v${version}` : "";
      }

      function setApiStartedAtLabel(value) {
        const label = document.getElementById("apiStartedAt");
        if (!value) {
          label.textContent = "";
          label.title = "";
          return;
        }
        const date = new Date(value);
        label.textContent = Number.isNaN(date.valueOf()) ? `started ${value}` : `started ${date.toLocaleTimeString()}`;
        label.title = Number.isNaN(date.valueOf()) ? value : date.toLocaleString();
      }

      function setApiUptimeLabel(value) {
        const label = document.getElementById("apiUptime");
        label.textContent = typeof value === "number" ? `up ${Math.round(value)}s` : "";
        label.title = typeof value === "number" ? `${value}s` : "";
      }

      function setApiInstanceLabel(value) {
        const label = document.getElementById("apiInstance");
        label.textContent = value ? `instance ${value}` : "";
        label.title = value || "";
      }

      function setApiBuildLabel(value) {
        const label = document.getElementById("apiBuild");
        label.textContent = value ? `build ${value}` : "";
        label.title = value || "";
      }

      function setApiRefreshHint(text) {
        const label = document.getElementById("apiRefreshHint");
        label.textContent = text;
        if (text) {
          setTimeout(() => {
            if (label.textContent === text) label.textContent = "";
          }, 2000);
        }
      }

      function setApiHealthUpdated() {
        const label = document.getElementById("apiHealthUpdated");
        const now = new Date();
        label.textContent = `updated ${now.toLocaleTimeString()}`;
        label.title = now.toLocaleString();
      }

      function setApiHealthLastError(text) {
        const label = document.getElementById("apiHealthLastError");
        label.textContent = text || "";
      }

      function copyApiHealthLastError() {
        const label = document.getElementById("apiHealthLastError");
        const text = label.textContent || "";
        if (!text.trim()) return;
        navigator.clipboard
          .writeText(text)
          .then(() => {
            setApiRefreshHint("Last error copied");
            label.classList.add("highlight-copy");
            setTimeout(() => label.classList.remove("highlight-copy"), 1200);
          })
          .catch(() => {
            setApiRefreshHint("Last error copy failed");
          });
      }

      function clearApiHealthLastError() {
        setApiHealthLastError("");
        setApiRefreshHint("Last error cleared");
      }

      function setApiHealthErrorsStatus(text) {
        const label = document.getElementById("apiHealthErrorsStatus");
        label.textContent = text;
      }

      async function copyApiHealth() {
        const base = getApiBaseUrl();
        if (!base) {
          setApiRefreshHint("Set base URL first");
          return;
        }
        try {
          const res = await fetch(`${base}/health`);
          const data = await res.json();
          await navigator.clipboard.writeText(JSON.stringify(data, null, 2));
          setApiRefreshHint("Health copied");
        } catch {
          setApiRefreshHint("Health copy failed");
          setApiHealthLastError("copy failed");
        }
      }

      function setApiRefreshStatus(text) {
        const label = document.getElementById("apiRefreshStatus");
        label.textContent = text;
        label.classList.remove("refresh-active", "refresh-paused", "refresh-disabled");
        if (text === "active") label.classList.add("refresh-active");
        if (text === "paused") label.classList.add("refresh-paused");
        if (text === "disabled") label.classList.add("refresh-disabled");
      }

      function setApiSettingsStatus(text) {
        const label = document.getElementById("apiSettingsStatus");
        if (text === "collapsed") {
          label.textContent = "";
          label.title = "";
          return;
        }
        label.textContent = text;
        label.title = `settings ${text}`;
      }

      function setApiAdvancedHint(text) {
        const label = document.getElementById("apiAdvancedHint");
        label.textContent = text ? "Show advanced settings" : "";
        label.style.display = text ? "inline-block" : "none";
      }

      function expandApiSettings() {
        if (document.getElementById("apiSettingsPanel").style.display === "none") {
          toggleApiSettings();
        }
      }

      function setApiRefreshIntervalDisplay() {
        const label = document.getElementById("apiRefreshIntervalDisplay");
        const enabled = document.getElementById("apiAutoRefresh").checked;
        const panel = document.getElementById("apiSettingsPanel");
        if (!enabled || panel.style.display === "none") {
          label.style.display = "none";
          label.textContent = "";
          return;
        }
        label.style.display = "inline";
        label.textContent = `interval ${getApiRefreshInterval()}s`;
      }

      function setApiRefreshCountdown() {
        const label = document.getElementById("apiRefreshCountdown");
        const enabled = document.getElementById("apiAutoRefresh").checked;
        const panel = document.getElementById("apiSettingsPanel");
        if (!enabled || panel.style.display === "none") {
          label.style.display = "none";
          label.textContent = "";
          label.title = "";
          label.style.cursor = "default";
          return;
        }
        if (apiRefreshPaused) {
          const remaining = apiPausedRemaining !== null ? apiPausedRemaining : "-";
          label.style.display = "inline";
          label.textContent = `paused ${remaining}s`;
          label.title = "auto refresh paused";
          label.style.cursor = "not-allowed";
          return;
        }
        if (!apiNextRefreshAt) {
          label.style.display = "none";
          label.textContent = "";
          label.title = "";
          label.style.cursor = "default";
          return;
        }
        const remaining = Math.max(0, Math.ceil((apiNextRefreshAt - Date.now()) / 1000));
        const nextTime = new Date(apiNextRefreshAt);
        label.style.display = "inline";
        label.textContent = `next ${remaining}s`;
        label.title = `next refresh at ${nextTime.toLocaleString()}`;
        label.style.cursor = "pointer";
      }

      function updateRefreshCountdownCursor() {
        setApiRefreshCountdown();
      }

      function scheduleNextRefresh() {
        apiNextRefreshAt = Date.now() + getApiRefreshInterval() * 1000;
        apiPausedRemaining = null;
        setApiRefreshCountdown();
      }

      function startApiRefreshCountdown() {
        stopApiRefreshCountdown();
        apiRefreshCountdownTimer = setInterval(() => {
          setApiRefreshCountdown();
        }, 1000);
      }

      function stopApiRefreshCountdown() {
        if (apiRefreshCountdownTimer) {
          clearInterval(apiRefreshCountdownTimer);
          apiRefreshCountdownTimer = null;
        }
        apiNextRefreshAt = null;
        setApiRefreshCountdown();
      }

      function setApiSettingsCountdownVisibility() {
        setApiRefreshIntervalDisplay();
        setApiRefreshCountdown();
      }

      function setApiSettingsToggleLabel(isVisible) {
        const button = document.getElementById("apiSettingsToggle");
        button.textContent = isVisible ? "Hide API Settings" : "Show API Settings";
      }

      function setApiRefreshControlsVisibility(isVisible) {
        const controls = document.getElementById("apiRefreshControls");
        controls.style.display = isVisible ? "block" : "none";
      }

      function toggleApiSettings() {
        const panel = document.getElementById("apiSettingsPanel");
        const divider = document.getElementById("apiAdvancedDivider");
        const next = panel.style.display === "none" ? "block" : "none";
        panel.style.display = next;
        panel.style.marginTop = next === "block" ? "" : "0";
        panel.style.paddingTop = next === "block" ? "" : "0";
        divider.style.display = next === "block" ? "block" : "none";
        localStorage.setItem("apiSettingsVisible", next === "block" ? "1" : "0");
        setApiSettingsStatus(next === "block" ? "expanded" : "collapsed");
        setApiSettingsToggleLabel(next === "block");
        setApiSettingsCountdownVisibility();
        setApiRefreshControlsVisibility(next === "block");
        setApiAdvancedHint(next === "block" ? "" : "advanced hidden");
      }

      function loadApiSettingsVisibility() {
        const saved = localStorage.getItem("apiSettingsVisible");
        const panel = document.getElementById("apiSettingsPanel");
        const divider = document.getElementById("apiAdvancedDivider");
        if (saved === "0") {
          panel.style.display = "none";
          panel.style.marginTop = "0";
          panel.style.paddingTop = "0";
          divider.style.display = "none";
          setApiSettingsStatus("collapsed");
          setApiSettingsToggleLabel(false);
          setApiRefreshControlsVisibility(false);
          setApiAdvancedHint("advanced hidden");
        } else {
          divider.style.display = "block";
          setApiSettingsStatus("expanded");
          setApiSettingsToggleLabel(true);
          setApiRefreshControlsVisibility(true);
          setApiAdvancedHint("");
        }
        setApiSettingsCountdownVisibility();
      }

      function setApiHealthErrors(errors) {
        const label = document.getElementById("apiHealthErrors");
        const detail = document.getElementById("apiHealthErrorsDetail");
        const copyButton = document.getElementById("apiHealthErrorsCopy");
        if (Array.isArray(errors) && errors.length) {
          label.textContent = `health: ${errors.join(", ")}`;
          detail.textContent = JSON.stringify(errors, null, 2);
          setApiHealthErrorsStatus(`(${errors.length} errors)`);
          copyButton.disabled = false;
          if (detail.style.display === "none") {
            setApiRefreshHint("errors detected (details collapsed)");
          }
        } else {
          label.textContent = "";
          detail.textContent = "";
          detail.style.display = "none";
          setApiHealthErrorsStatus("(no errors)");
          copyButton.disabled = true;
        }
      }

      function clearApiHealthErrors() {
        setApiHealthErrors([]);
      }

      function toggleApiHealthErrorsDetail() {
        const detail = document.getElementById("apiHealthErrorsDetail");
        const next = detail.style.display === "none" ? "block" : "none";
        detail.style.display = next;
        if (next === "block") {
          detail.scrollIntoView({ behavior: "smooth" });
        }
        localStorage.setItem("apiHealthErrorsVisible", next === "block" ? "1" : "0");
      }

      function copyApiHealthErrorsDetail() {
        const detail = document.getElementById("apiHealthErrorsDetail");
        const text = detail.textContent || "";
        if (!text.trim()) return;
        if (detail.style.display === "none") {
          detail.style.display = "block";
        }
        navigator.clipboard
          .writeText(text)
          .then(() => {
            setApiRefreshHint("Error details copied");
            detail.classList.add("highlight-copy");
            setTimeout(() => detail.classList.remove("highlight-copy"), 1200);
          })
          .catch(() => {
            setApiRefreshHint("Error details copy failed");
          });
      }

      function persistApiHealthErrorsDefault() {
        const collapsed = document.getElementById("apiHealthErrorsDefault").checked;
        localStorage.setItem("apiHealthErrorsDefaultCollapsed", collapsed ? "1" : "0");
        if (collapsed) {
          document.getElementById("apiHealthErrorsDetail").style.display = "none";
          localStorage.setItem("apiHealthErrorsVisible", "0");
        }
      }

      function loadApiHealthErrorsVisibility() {
        const saved = localStorage.getItem("apiHealthErrorsVisible");
        const defaultCollapsed = localStorage.getItem("apiHealthErrorsDefaultCollapsed");
        const defaultHidden = saved === "0" || defaultCollapsed === "1";
        if (defaultCollapsed === "1") {
          document.getElementById("apiHealthErrorsDefault").checked = true;
        }
        if (defaultHidden) {
          document.getElementById("apiHealthErrorsDetail").style.display = "none";
          setApiHealthErrorsStatus("collapsed");
        } else {
          setApiHealthErrorsStatus("expanded");
        }
      }

      function persistApiAutoRefresh() {
        const enabled = document.getElementById("apiAutoRefresh").checked;
        localStorage.setItem("apiAutoRefresh", enabled ? "1" : "0");
        updateApiPauseButton();
      }

      function persistApiRefreshInterval() {
        const rawValue = document.getElementById("apiRefreshInterval").value;
        const value = Number(rawValue || 5);
        if (!Number.isFinite(value) || value <= 0) {
          setApiRefreshHint("Invalid interval");
          document.getElementById("apiRefreshInterval").value = "5";
          localStorage.setItem("apiRefreshInterval", "5");
          setApiRefreshIntervalDisplay();
          return;
        }
        localStorage.setItem("apiRefreshInterval", String(Math.max(1, value)));
        setApiRefreshHint("Interval saved");
        setApiRefreshIntervalDisplay();
        if (document.getElementById("apiAutoRefresh").checked && !apiRefreshPaused) {
          startApiAutoRefresh();
          refreshApiInfo();
        }
      }

      function toggleApiAutoRefresh() {
        persistApiAutoRefresh();
        const enabled = document.getElementById("apiAutoRefresh").checked;
        if (enabled) {
          apiRefreshPaused = false;
          updateApiPauseButton();
          setApiRefreshIntervalDisplay();
          startApiAutoRefresh();
          refreshApiInfo();
        } else {
          stopApiAutoRefresh();
          setApiRefreshIntervalDisplay();
          setApiRefreshHint("");
        }
        setApiRefreshCountdown();
      }

      function toggleApiAutoPause() {
        if (!document.getElementById("apiAutoRefresh").checked) {
          setApiRefreshHint("Enable auto refresh first");
          return;
        }
        apiRefreshPaused = !apiRefreshPaused;
        localStorage.setItem("apiAutoRefreshPaused", apiRefreshPaused ? "1" : "0");
        updateApiPauseButton();
        if (apiRefreshPaused) {
          stopApiAutoRefresh();
          apiRefreshPausedAt = Date.now();
        } else if (document.getElementById("apiAutoRefresh").checked) {
          startApiAutoRefresh();
        }
      }

      function pauseAutoRefresh(reason) {
        if (!document.getElementById("apiAutoRefresh").checked) return;
        apiRefreshPaused = true;
        apiRefreshPausedAt = Date.now();
        if (apiNextRefreshAt) {
          apiPausedRemaining = Math.max(0, Math.ceil((apiNextRefreshAt - Date.now()) / 1000));
        }
        localStorage.setItem("apiAutoRefreshPaused", "1");
        updateApiPauseButton();
        stopApiAutoRefresh();
        if (reason) setApiRefreshHint(reason);
        setApiRefreshStatus("paused");
        setApiRefreshCountdown();
      }

      function resumeAutoRefresh(reason) {
        if (!document.getElementById("apiAutoRefresh").checked) return;
        apiRefreshPaused = false;
        apiPausedRemaining = null;
        localStorage.setItem("apiAutoRefreshPaused", "0");
        updateApiPauseButton();
        startApiAutoRefresh();
        if (apiRefreshPausedAt) {
          const seconds = Math.round((Date.now() - apiRefreshPausedAt) / 1000);
          setApiRefreshHint(`auto refresh resumed after ${seconds}s`);
          apiRefreshPausedAt = null;
        } else if (reason) {
          setApiRefreshHint(reason);
        }
        setApiRefreshStatus("active");
        setApiRefreshCountdown();
      }

      function updateApiPauseButton() {
        const button = document.getElementById("apiRefreshPause");
        const enabled = document.getElementById("apiAutoRefresh").checked;
        button.disabled = !enabled;
        button.textContent = apiRefreshPaused ? "Resume" : "Pause";
        if (!enabled) {
          setApiRefreshStatus("disabled");
        } else if (apiRefreshPaused) {
          setApiRefreshStatus("paused");
        } else {
          setApiRefreshStatus("active");
        }
      }

      function startApiAutoRefresh() {
        stopApiAutoRefresh();
        const interval = getApiRefreshInterval();
        scheduleNextRefresh();
        startApiRefreshCountdown();
        apiRefreshTimer = setInterval(() => {
          refreshApiInfo();
          scheduleNextRefresh();
        }, interval * 1000);
      }

      function manualApiRefresh() {
        const countdown = document.getElementById("apiRefreshCountdown");
        if (apiRefreshPaused) {
          setApiRefreshHint("auto refresh paused");
          return;
        }
        refreshApiInfo();
        setApiRefreshHint("refreshed");
        countdown.classList.add("highlight-refresh");
        setTimeout(() => countdown.classList.remove("highlight-refresh"), 800);
        document.getElementById("apiRefreshPause").focus();
        if (document.getElementById("apiAutoRefresh").checked && !apiRefreshPaused) {
          scheduleNextRefresh();
        }
      }

      function stopApiAutoRefresh() {
        if (apiRefreshTimer) {
          clearInterval(apiRefreshTimer);
          apiRefreshTimer = null;
        }
        stopApiRefreshCountdown();
      }

      function getApiRefreshInterval() {
        const raw = localStorage.getItem("apiRefreshInterval");
        const value = raw ? Number(raw) : Number(document.getElementById("apiRefreshInterval").value || 5);
        return Number.isFinite(value) && value > 0 ? value : 5;
      }

      function loadApiAutoRefresh() {
        const saved = localStorage.getItem("apiAutoRefresh");
        if (saved === "1") {
          document.getElementById("apiAutoRefresh").checked = true;
        }
        const intervalRaw = localStorage.getItem("apiRefreshInterval");
        if (intervalRaw) {
          document.getElementById("apiRefreshInterval").value = intervalRaw;
        }
        apiRefreshPaused = localStorage.getItem("apiAutoRefreshPaused") === "1";
        if (apiRefreshPaused) {
          apiRefreshPausedAt = Date.now();
        }
        updateApiPauseButton();
        setApiRefreshIntervalDisplay();
        if (saved === "1" && !apiRefreshPaused) {
          startApiAutoRefresh();
          setApiRefreshStatus("active");
        } else if (saved === "1" && apiRefreshPaused) {
          setApiRefreshStatus("paused");
        }
        setApiRefreshCountdown();
      }

      function copyApiVersion() {
        const text = document.getElementById("apiVersion").textContent || "";
        if (!text.trim()) return;
        navigator.clipboard.writeText(text);
        setHint("apiBaseHint", "Version copied");
      }

      async function refreshApiInfo() {
        const base = getApiBaseUrl();
        if (!base) {
          setApiVersionLabel("");
          setApiStartedAtLabel("");
          setApiUptimeLabel("");
          setApiInstanceLabel("");
          setApiBuildLabel("");
          setApiHealthErrors([]);
          setApiHealthUpdated();
          return;
        }
        try {
          const res = await fetch(`${base}/health`);
          const data = await res.json();
          if (data.status === "ok") {
            setApiVersionLabel(data.version || "");
            setApiStartedAtLabel(data.startedAt || "");
            setApiUptimeLabel(data.uptimeSec);
            setApiInstanceLabel(data.instanceId || "");
            setApiBuildLabel(data.buildCommit || "");
            setApiHealthErrors(data.errors || []);
            setApiHealthUpdated();
            if (Array.isArray(data.errors) && data.errors.length) {
              setApiRefreshHint(`health issues: ${data.errors.join(", ")}`);
              setApiHealthLastError(data.errors.join(", "));
            } else {
              setApiHealthLastError("");
            }
            if (apiRefreshPaused && document.getElementById("apiAutoRefresh").checked) {
              resumeAutoRefresh("auto refresh resumed");
            }
          } else {
            setApiRefreshHint("health check failed");
            setApiHealthLastError("health check failed");
            pauseAutoRefresh("auto refresh paused");
          }
        } catch (error) {
          setApiVersionLabel("");
          setApiStartedAtLabel("");
          setApiUptimeLabel("");
          setApiInstanceLabel("");
          setApiBuildLabel("");
          setApiHealthErrors([]);
          setApiRefreshHint("health check failed");
          setApiHealthLastError("health check failed");
          pauseAutoRefresh("auto refresh paused");
        }
      }

      async function checkNodeApi() {
        const fastApi = "http://127.0.0.1:8000";
        try {
          const res = await fetch(`${fastApi}/health/node`);
          const data = await res.json();
          if (data.status === "ok") {
            const latency = data.latencyMs ? ` (${data.latencyMs}ms)` : "";
            setHint("apiBaseHint", `Node ok${latency}`);
          } else {
            setHint("apiBaseHint", "Node check failed");
          }
        } catch {
          setHint("apiBaseHint", "Node unreachable - consider FastAPI");
        }
      }

      function setApiBaseTypeLabel() {
        const base = getApiBaseUrl();
        const label = document.getElementById("apiBaseType");
        const nodeBtn = document.getElementById("apiUseNode");
        const fastBtn = document.getElementById("apiUseFast");
        label.classList.remove("api-node", "api-fastapi", "api-custom");
        nodeBtn.classList.remove("api-choice-active");
        fastBtn.classList.remove("api-choice-active");
        if (!base) {
          label.textContent = "Node (default)";
          label.classList.add("api-node");
          nodeBtn.classList.add("api-choice-active");
          setHint("apiBaseHint", "Using current page API");
          setApiBaseCurrent("");
          return;
        }
        if (base.includes(":8000")) {
          label.textContent = "FastAPI";
          label.classList.add("api-fastapi");
          fastBtn.classList.add("api-choice-active");
        } else if (base.includes(":4173")) {
          label.textContent = "Node";
          label.classList.add("api-node");
          nodeBtn.classList.add("api-choice-active");
        } else {
          label.textContent = "Custom";
          label.classList.add("api-custom");
        }
        setApiBaseCurrent(base);
      }

      function validateApiBaseUrl() {
        const input = document.getElementById("apiBaseUrl");
        const value = input.value.trim();
        if (!value) {
          input.style.borderColor = "";
          return true;
        }
        try {
          const url = new URL(value);
          if (!url.protocol.startsWith("http")) throw new Error("invalid");
          input.style.borderColor = "";
          return true;
        } catch {
          input.style.borderColor = "red";
          return false;
        }
      }

      function setApiBaseCurrent(value) {
        const label = document.getElementById("apiBaseCurrent");
        label.textContent = value ? `current ${value}` : "";
      }

      function copyApiBaseCurrent() {
        const label = document.getElementById("apiBaseCurrent");
        const text = label.textContent.replace(/^current\s+/, "");
        if (!text.trim()) return;
        navigator.clipboard
          .writeText(text)
          .then(() => {
            setHint("apiBaseHint", "Current URL copied");
            label.classList.add("highlight-copy");
            setTimeout(() => label.classList.remove("highlight-copy"), 800);
          })
          .catch(() => setHint("apiBaseHint", "Copy failed"));
      }

      function updateApiBaseHistory(value) {
        if (!value) return;
        const raw = localStorage.getItem("apiBaseHistory");
        const history = raw ? JSON.parse(raw) : [];
        const next = [value, ...history.filter((item) => item !== value)].slice(0, 5);
        localStorage.setItem("apiBaseHistory", JSON.stringify(next));
        renderApiBaseHistory(next);
      }

      function clearApiBaseHistory() {
        localStorage.removeItem("apiBaseHistory");
        renderApiBaseHistory([]);
        setHint("apiBaseHint", "History cleared (max 5 stored)");
      }

      function clearApiBaseHistoryConfirm() {
        if (confirm("Clear API base URL history?")) {
          clearApiBaseHistory();
        }
      }

      function renderApiBaseHistory(items) {
        const list = document.getElementById("apiBaseHistory");
        list.innerHTML = "";
        items.forEach((item) => {
          const option = document.createElement("option");
          option.value = item;
          list.appendChild(option);
        });
      }

      function loadApiBaseHistory() {
        const raw = localStorage.getItem("apiBaseHistory");
        const items = raw ? JSON.parse(raw) : [];
        renderApiBaseHistory(items);
      }

      async function autoDetectApiBaseUrl() {
        const stored = getApiBaseUrl();
        if (stored) return;
        const fastApi = "http://127.0.0.1:8000";
        try {
          const res = await fetch(`${fastApi}/health`);
          const data = await res.json();
          if (data.status === "ok") {
            setApiBaseUrl(fastApi);
            setHint("apiBaseHint", "Auto-switched to FastAPI");
          }
        } catch {
          setHint("apiBaseHint", "Using Node (default)");
        }
      }

      async function loadStrategies() {
        const res = await apiFetch("/api/strategies");
        const data = await res.json();
        document.getElementById("strategyList").textContent = JSON.stringify(data, null, 2);
      }

      async function loadExecutions() {
        const res = await apiFetch("/api/executions");
        const data = await res.json();
        document.getElementById("executionList").textContent = JSON.stringify(data, null, 2);
        const evidence = (data.executions || []).map((item) => item.evidence || null);
        document.getElementById("executionEvidence").textContent = JSON.stringify(evidence, null, 2);
        const showExtra = document.getElementById("summaryFields").checked;
        const summary = (data.executions || []).map((item) => {
          const base = {
            runId: item.id,
            strategyId: item.strategyId,
            mode: item.mode,
            status: item.status,
            executedAt: item.evidence?.executedAt,
            createdAt: item.createdAt,
            template: item.evidence?.template,
          };
          if (!showExtra) return base;
          return {
            ...base,
            routeId: item.evidence?.routeId,
            txHash: item.evidence?.txHash,
            tool: item.evidence?.tool,
            gasEstimate: item.evidence?.estimateGas,
            templateParams: item.evidence?.templateParams,
          };
        });
        const sortTime = document.getElementById("summarySortTime").checked;
        const sorted = sortTime
          ? [...summary].sort((a, b) => String(b.executedAt || "").localeCompare(String(a.executedAt || "")))
          : summary;
        const filtered = filterSummary(sorted).slice(0, summaryLimit);
        window.latestSummary = filtered;
        const summaryElement = document.getElementById("executionSummary");
        summaryElement.textContent = JSON.stringify(filtered, null, 2);
        renderSummaryList(filtered);
      }

      function renderSummaryList(summary) {
        const list = document.getElementById("executionSummaryList");
        list.innerHTML = "";
        summary.forEach((item) => {
          const row = document.createElement("div");
          row.style.cursor = "pointer";
          row.style.padding = "4px 0";
          row.className = statusRowClass(item.status);
          const compactView = document.getElementById("summaryCompact").checked;
          const showTime = document.getElementById("summaryShowTime").checked;
          const showRoute = document.getElementById("summaryShowRoute").checked;
          const showTx = document.getElementById("summaryShowTx").checked;
          const timeText = showTime ? ` | ${formatSummaryTime(item.executedAt || item.createdAt)}` : "";
          const routeText = showRoute ? ` | ${item.routeId || "-"}` : "";
          const txText = showTx ? ` | ${item.txHash || "-"}` : "";
          if (compactView) {
            row.innerHTML = `${item.runId} | <span class="badge ${statusBadgeClass(item.status)}">${item.status}</span> | <span class="badge ${modeBadgeClass(item.mode)}">${item.mode}</span>${timeText}`;
          } else {
            row.innerHTML = `${item.runId} | <span class="badge ${statusBadgeClass(item.status)}">${item.status}</span> | <span class="badge ${modeBadgeClass(item.mode)}">${item.mode}</span>${routeText}${txText}${timeText}`;
          }
          row.onclick = () => {
            document.querySelectorAll("#executionSummaryList .selected").forEach((node) => {
              node.classList.remove("selected");
            });
            row.classList.add("selected");
            window.latestSummarySelection = item;
            loadExecutionDetail(item.runId);
          };
          row.title = `strategy=${item.strategyId} route=${item.routeId || "-"} tx=${item.txHash || "-"}`;
          row.oncontextmenu = (event) => {
            event.preventDefault();
            const payload = item.txHash
              ? `${item.runId} | ${item.txHash} | ${item.status}`
              : `${item.runId} | ${item.status}`;
            navigator.clipboard.writeText(payload);
            setHint("summaryRowCopyHint", "Copied row");
          };
          row.ondblclick = () => {
            navigator.clipboard.writeText(JSON.stringify(item, null, 2));
            setHint("summaryCopyHint", "Copied JSON");
          };
          row.onmouseenter = () => {
            row.dataset.originalTitle = row.title;
            const baseTitle = row.dataset.originalTitle || "";
            row.title = baseTitle
              ? `${baseTitle} | Double-click to copy JSON`
              : "Double-click to copy JSON";
          };
          row.onmouseleave = () => {
            row.title = row.dataset.originalTitle || row.title;
          };
          list.appendChild(row);
        });
        window.latestSummary = summary;
      }

      function statusRowClass(status) {
        if (status === "execute" || status === "executed") return "row-execute";
        if (status === "simulated") return "row-simulated";
        return "row-planned";
      }

      function statusBadgeClass(status) {
        if (status === "execute" || status === "executed") return "badge-status-execute";
        if (status === "simulated") return "badge-status-simulated";
        return "badge-status-planned";
      }

      function modeBadgeClass(mode) {
        if (mode === "execute") return "badge-mode-execute";
        if (mode === "simulate") return "badge-mode-simulate";
        return "badge-mode-plan";
      }

      function formatSummaryTime(value) {
        if (!value) return "-";
        const date = new Date(value);
        if (Number.isNaN(date.valueOf())) return "-";
        const shortTime = document.getElementById("summaryShortTime").checked;
        if (shortTime) {
          return `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
        }
        return date.toISOString();
      }

      function filterSummary(summary) {
        const statusFilter = document.getElementById("summaryStatus").value.trim();
        const modeFilter = document.getElementById("summaryMode").value.trim();
        const search = document.getElementById("summarySearch").value.trim();
        return summary.filter((item) => {
          if (statusFilter && item.status !== statusFilter) return false;
          if (modeFilter && item.mode !== modeFilter) return false;
          if (
            search &&
            !(
              `${item.runId}`.includes(search) ||
              `${item.strategyId}`.includes(search) ||
              `${item.txHash || ""}`.includes(search)
            )
          ) {
            return false;
          }
          return true;
        });
      }

      function saveSummaryFilters() {
        const payload = {
          status: document.getElementById("summaryStatus").value.trim(),
          mode: document.getElementById("summaryMode").value.trim(),
          search: document.getElementById("summarySearch").value.trim(),
        };
        localStorage.setItem("summaryFilters", JSON.stringify(payload));
      }

      function loadSummaryFilters() {
        const raw = localStorage.getItem("summaryFilters");
        if (!raw) return;
        const payload = JSON.parse(raw);
        document.getElementById("summaryStatus").value = payload.status || "";
        document.getElementById("summaryMode").value = payload.mode || "";
        document.getElementById("summarySearch").value = payload.search || "";
      }

      function saveSummaryPrefs() {
        const payload = {
          fields: document.getElementById("summaryFields").checked,
          showTime: document.getElementById("summaryShowTime").checked,
          shortTime: document.getElementById("summaryShortTime").checked,
          showRoute: document.getElementById("summaryShowRoute").checked,
          showTx: document.getElementById("summaryShowTx").checked,
          compact: document.getElementById("summaryCompact").checked,
          sortTime: document.getElementById("summarySortTime").checked,
        };
        localStorage.setItem("summaryPrefs", JSON.stringify(payload));
      }

      function loadSummaryPrefs() {
        const raw = localStorage.getItem("summaryPrefs");
        if (!raw) return;
        const payload = JSON.parse(raw);
        if (typeof payload.fields === "boolean") {
          document.getElementById("summaryFields").checked = payload.fields;
        }
        if (typeof payload.showTime === "boolean") {
          document.getElementById("summaryShowTime").checked = payload.showTime;
        }
        if (typeof payload.shortTime === "boolean") {
          document.getElementById("summaryShortTime").checked = payload.shortTime;
        }
        if (typeof payload.showRoute === "boolean") {
          document.getElementById("summaryShowRoute").checked = payload.showRoute;
        }
        if (typeof payload.showTx === "boolean") {
          document.getElementById("summaryShowTx").checked = payload.showTx;
        }
        if (typeof payload.compact === "boolean") {
          document.getElementById("summaryCompact").checked = payload.compact;
        }
        if (typeof payload.sortTime === "boolean") {
          document.getElementById("summarySortTime").checked = payload.sortTime;
        }
      }

      function attachSummaryFilterListeners() {
        ["summaryStatus", "summaryMode", "summarySearch"].forEach((id) => {
          const input = document.getElementById(id);
          input.addEventListener("input", () => {
            saveSummaryFilters();
            loadExecutions();
          });
          input.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
              saveSummaryFilters();
              loadExecutions();
            }
          });
        });
        [
          "summaryFields",
          "summaryShowTime",
          "summaryShortTime",
          "summaryShowRoute",
          "summaryShowTx",
          "summaryCompact",
          "summarySortTime",
        ].forEach((id) => {
          const input = document.getElementById(id);
          input.addEventListener("change", () => {
            saveSummaryPrefs();
            loadExecutions();
          });
        });
      }

      function exportSummary() {
        const data = window.latestSummary || [];
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "execution-summary.json";
        a.click();
        URL.revokeObjectURL(url);
      }

      function exportSummaryCsv() {
        const data = window.latestSummary || [];
        if (!data.length) return;
        const headers = Object.keys(data[0]);
        const rows = [headers.join(",")].concat(
          data.map((row) => headers.map((key) => JSON.stringify(row[key] ?? "")).join(","))
        );
        const blob = new Blob([rows.join("\n")], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "execution-summary.csv";
        a.click();
        URL.revokeObjectURL(url);
      }

      function copySummaryCsv() {
        const data = window.latestSummary || [];
        if (!data.length) return;
        const headers = Object.keys(data[0]);
        const rows = [headers.join(",")].concat(
          data.map((row) => headers.map((key) => JSON.stringify(row[key] ?? "")).join(","))
        );
        navigator.clipboard.writeText(rows.join("\n"));
      }

      function copySummaryJson() {
        const data = window.latestSummary || [];
        navigator.clipboard.writeText(JSON.stringify(data, null, 2));
      }

      function toggleSummaryJson() {
        const pre = document.getElementById("executionSummary");
        pre.style.display = pre.style.display === "none" ? "block" : "none";
      }

      function toggleSummaryList() {
        const list = document.getElementById("executionSummaryList");
        list.style.display = list.style.display === "none" ? "block" : "none";
      }

      function persistKeepRunResult() {
        const checked = document.getElementById("keepRunResult").checked;
        localStorage.setItem("keepRunResult", checked ? "1" : "0");
      }

      function loadKeepRunResult() {
        const saved = localStorage.getItem("keepRunResult");
        if (saved === "1") {
          document.getElementById("keepRunResult").checked = true;
        }
      }

      function clearRunInputsConfirm() {
        if (confirm("Clear runEvidence and runLifi?")) {
          clearRunInputs();
        }
      }

      function clearParamsJson() {
        document.getElementById("params").value = "";
      }

      function formatParamsJson() {
        const textarea = document.getElementById("params");
        if (!textarea.value.trim()) return;
        try {
          textarea.value = JSON.stringify(JSON.parse(textarea.value), null, 2);
        } catch (error) {
          document.getElementById("createResult").textContent = `Params JSON invalid: ${error.message || error}`;
        }
      }

      function quickFilter(kind, value) {
        if (kind === "status") {
          document.getElementById("summaryStatus").value = value;
        }
        if (kind === "mode") {
          document.getElementById("summaryMode").value = value;
        }
        saveSummaryFilters();
        loadExecutions();
      }

      function copySelectedSummaryRow() {
        const item = window.latestSummarySelection;
        if (!item) {
          setHint("summaryRowCopyHint", "No row selected");
          return;
        }
        navigator.clipboard.writeText(JSON.stringify(item, null, 2));
        setHint("summaryRowCopyHint", "Copied row");
      }

      function clearRunInputs() {
        document.getElementById("runEvidence").value = "";
        document.getElementById("runLifi").value = "";
      }

      function resetCreateForm() {
        document.getElementById("intentText").value = "";
        document.getElementById("template").value = "";
        document.getElementById("templateSelect").value = "";
        document.getElementById("params").value = "";
        document.getElementById("risk").value = "";
        document.getElementById("paramFields").innerHTML = "";
        document.getElementById("paramHints").innerHTML = "";
        document.getElementById("templateInfo").innerHTML = "";
        document.getElementById("optionalInfo").innerHTML = "";
        document.getElementById("createResult").textContent = "";
      }

      function clearSummaryFilters() {
        document.getElementById("summaryStatus").value = "";
        document.getElementById("summaryMode").value = "";
        document.getElementById("summarySearch").value = "";
        summaryLimit = 10;
        localStorage.removeItem("summaryFilters");
        loadExecutions();
      }

      function renderParamFields(templateName) {
        const container = document.getElementById("paramFields");
        const hints = document.getElementById("paramHints");
        const info = document.getElementById("templateInfo");
        const optionalInfo = document.getElementById("optionalInfo");
        container.innerHTML = "";
        hints.innerHTML = "";
        info.innerHTML = "";
        optionalInfo.innerHTML = "";
        const template = templateCache.find((item) => item.template === templateName);
        if (!template || !template.requiredParams) return;
        info.textContent = `${template.title}: ${template.description}`;
        if (template.optionalParams && template.optionalParams.length) {
          optionalInfo.textContent = `Optional params: ${template.optionalParams.join(", ")}`;
        }
        const hintList = document.createElement("ul");
        template.requiredParams.forEach((param) => {
          renderParamInput({ param, template, container, hintList, required: true });
        });
        (template.optionalParams || []).forEach((param) => {
          renderParamInput({ param, template, container, hintList, required: false });
        });
        hints.appendChild(hintList);
        hideOptionalParams();
        focusFirstRequired();
      }

      function hideOptionalParams() {
        document.querySelectorAll("input[data-param-required='false']").forEach((input) => {
          const parent = input.parentElement;
          if (!parent) return;
          parent.style.display = "none";
        });
      }

      function toggleOptionalParams() {
        document.querySelectorAll("input[data-param-required='false']").forEach((input) => {
          const parent = input.parentElement;
          if (!parent) return;
          const display = parent.style.display;
          parent.style.display = display === "none" ? "block" : "none";
        });
      }

      function renderParamInput({ param, template, container, hintList, required }) {
        const wrapper = document.createElement("div");
        const label = document.createElement("label");
        label.textContent = required ? `${param} *` : `${param} (optional)`;
        const input = document.createElement("input");
        input.dataset.param = param;
        input.dataset.paramRequired = required ? "true" : "false";
        input.placeholder = param;
        if (template.paramMeta && template.paramMeta[param]) {
          input.dataset.paramType = template.paramMeta[param].type;
        }
        wrapper.appendChild(label);
        wrapper.appendChild(input);
        container.appendChild(wrapper);

        const hint = document.createElement("li");
        hint.textContent = `${param}: ${sampleHint(param, template)}`;
        hintList.appendChild(hint);
      }

      function sampleHint(param, template) {
        if (template && template.paramMeta && template.paramMeta[param]) {
          const meta = template.paramMeta[param];
          return `${meta.type}${meta.example ? `, e.g. ${meta.example}` : ""}`;
        }
        return "";
      }

      function fillParamExamples() {
        const templateName = document.getElementById("template").value;
        const template = templateCache.find((item) => item.template === templateName);
        if (!template || !template.paramMeta) return;
        document.querySelectorAll("input[data-param]").forEach((input) => {
          const meta = template.paramMeta[input.dataset.param];
          if (meta && meta.example) {
            input.value = meta.example;
          }
        });
      }

      function clearParamFields() {
        document.querySelectorAll("input[data-param]").forEach((input) => {
          input.value = "";
          input.style.borderColor = "";
        });
      }

      async function loadTemplates() {
        const res = await apiFetch("/api/templates");
        const data = await res.json();
        templateCache = data.templates || [];
        document.getElementById("templateList").textContent = JSON.stringify(data, null, 2);
        const templateInput = document.getElementById("template");
        const templateSelect = document.getElementById("templateSelect");
        templateSelect.innerHTML = "<option value=\"\">-- choose template --</option>";
        templateCache.forEach((item) => {
          const opt = document.createElement("option");
          opt.value = item.template;
          opt.textContent = `${item.template} (${item.title})`;
          templateSelect.appendChild(opt);
        });
        const lastTemplate = localStorage.getItem("lastTemplateSelect");
        if (lastTemplate) {
          templateSelect.value = lastTemplate;
          templateInput.value = lastTemplate;
          renderParamFields(lastTemplate);
        }
        templateInput.addEventListener("input", () => renderParamFields(templateInput.value));
      }

      function selectTemplate(value) {
        document.getElementById("template").value = value;
        renderParamFields(value);
      }

      async function loadExecutionDetail(runIdInput) {
        const runId = runIdInput || document.getElementById("detailRunId").value;
        if (!runId) return;
        const res = await apiFetch(`/api/executions/${runId}`);
        const data = await res.json();
        if (!data || !data.execution) {
          document.getElementById("executionDetail").textContent = JSON.stringify(data, null, 2);
          window.latestExecutionDetail = null;
          return;
        }
        const detail = {
          id: data.execution.id,
          strategyId: data.execution.strategyId,
          status: data.execution.status,
          mode: data.execution.mode,
          createdAt: data.execution.createdAt,
        };
        const evidence = data.execution.evidence || {};
        const payload = data.execution.payload || {};
        const templateParams = evidence.templateParams || {};
        const detailPayload = { detail, evidence, templateParams, payload };
        window.latestExecutionDetail = detailPayload;
        document.getElementById("executionDetail").textContent = JSON.stringify(detailPayload, null, 2);
        const highlights = {
          runId: detail.id || "-",
          txHash: evidence.txHash || "-",
          routeId: evidence.routeId || "-",
          status: detail.status || "-",
          mode: detail.mode || "-",
        };
        document.getElementById("executionDetailHighlights").textContent = JSON.stringify(highlights, null, 2);
        document.getElementById("executionDetail").scrollIntoView({ behavior: "smooth" });
      }

      function copyExecutionField(field) {
        const detail = window.latestExecutionDetail || {};
        if (field === "runId") {
          navigator.clipboard.writeText(detail.detail?.id || "");
        }
        if (field === "txHash") {
          navigator.clipboard.writeText(detail.evidence?.txHash || "");
        }
        if (field === "evidence") {
          navigator.clipboard.writeText(JSON.stringify(detail.evidence || {}, null, 2));
        }
        if (field === "payload") {
          navigator.clipboard.writeText(JSON.stringify(detail.payload || {}, null, 2));
        }
        if (field === "all") {
          navigator.clipboard.writeText(JSON.stringify(detail, null, 2));
        }
      }

      function copyExecutionHighlights() {
        const detail = window.latestExecutionDetail || {};
        const highlights = {
          runId: detail.detail?.id,
          txHash: detail.evidence?.txHash,
          routeId: detail.evidence?.routeId,
          status: detail.detail?.status,
          mode: detail.detail?.mode,
        };
        navigator.clipboard.writeText(JSON.stringify(highlights, null, 2));
        setHint("highlightCopyHint", "Copied");
      }

      function copyHighlightField(field) {
        const detail = window.latestExecutionDetail || {};
        const map = {
          routeId: detail.evidence?.routeId || "",
          status: detail.detail?.status || "",
          mode: detail.detail?.mode || "",
        };
        navigator.clipboard.writeText(map[field] || "");
        setHint("highlightCopyHint", `Copied ${field}`);
      }

      function updateExecutionHighlightsToggleLabel(isVisible) {
        const button = document.getElementById("toggleHighlightsBtn");
        button.textContent = isVisible ? "Hide Highlights" : "Show Highlights";
      }

      function toggleExecutionHighlights() {
        const el = document.getElementById("executionDetailHighlights");
        const next = el.style.display === "none" ? "block" : "none";
        el.style.display = next;
        localStorage.setItem("executionHighlightsVisible", next === "block" ? "1" : "0");
        updateExecutionHighlightsToggleLabel(next === "block");
      }

      function persistExecutionHighlightsDefault() {
        const collapsed = document.getElementById("executionHighlightsDefault").checked;
        localStorage.setItem("executionHighlightsDefaultCollapsed", collapsed ? "1" : "0");
        if (collapsed) {
          document.getElementById("executionDetailHighlights").style.display = "none";
          localStorage.setItem("executionHighlightsVisible", "0");
          updateExecutionHighlightsToggleLabel(false);
        }
      }

      function loadExecutionHighlightsVisibility() {
        const saved = localStorage.getItem("executionHighlightsVisible");
        const defaultCollapsed = localStorage.getItem("executionHighlightsDefaultCollapsed");
        const defaultHidden = saved === "0" || defaultCollapsed === "1";
        if (defaultCollapsed === "1") {
          document.getElementById("executionHighlightsDefault").checked = true;
        }
        if (defaultHidden) {
          document.getElementById("executionDetailHighlights").style.display = "none";
        }
        updateExecutionHighlightsToggleLabel(!defaultHidden);
      }

      function copyRunResult() {
        const el = document.getElementById("runResult");
        const text = el.textContent || "";
        if (!text.trim()) return;
        navigator.clipboard
          .writeText(text)
          .then(() => {
            selectRunResult();
            el.scrollTop = 0;
            setHint("runResultCopyHint", "Copied");
          })
          .catch(() => {
            setHint("runResultCopyHint", "Copy failed");
          });
      }

      function saveRunResultState(message, status) {
        if (!message) {
          localStorage.removeItem("runResultState");
          return;
        }
        localStorage.setItem("runResultState", JSON.stringify({ message, status }));
      }

      function loadRunResultState() {
        const raw = localStorage.getItem("runResultState");
        if (!raw) return;
        const payload = JSON.parse(raw);
        const el = document.getElementById("runResult");
        el.textContent = payload.message || "";
        el.classList.remove("status-ok", "status-error");
        if (payload.status === "ok") el.classList.add("status-ok");
        if (payload.status === "error") el.classList.add("status-error");
      }

      function clearRunResult() {
        const el = document.getElementById("runResult");
        el.textContent = "";
        el.classList.remove("status-ok", "status-error");
        el.scrollTop = 0;
        setHint("runResultCopyHint", "");
        saveRunResultState("", "");
      }

      function clearRunResultConfirm() {
        if (confirm("Clear run result?")) {
          clearRunResult();
        }
      }

      function selectRunResult() {
        const el = document.getElementById("runResult");
        const range = document.createRange();
        range.selectNodeContents(el);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
      }

      function saveEvidenceTemplate() {
        const text = document.getElementById("runEvidence").value;
        if (!text.trim()) return;
        localStorage.setItem("evidenceTemplate", text);
      }

      function loadEvidenceTemplate() {
        const text = localStorage.getItem("evidenceTemplate");
        if (text) {
          document.getElementById("runEvidence").value = text;
        }
      }

      function fillLifiTemplate() {
        const templateName = document.getElementById("template").value;
        if (!templateName || !templateName.includes("lifi")) {
          document.getElementById("runLifi").value = JSON.stringify({
            routeId: "route_...",
            tool: "lifi",
            estimateGas: "0",
            txHash: "0x...",
          }, null, 2);
          return;
        }
        document.getElementById("runLifi").value = JSON.stringify({
          routeId: "route_...",
          tool: "lifi",
          estimateGas: "0",
          txHash: "0x...",
        }, null, 2);
      }

      function clearEvidence() {
        document.getElementById("runEvidence").value = "";
      }

      function clearLifiResult() {
        document.getElementById("runLifi").value = "";
      }

      function setStatus(id, text) {
        const el = document.getElementById(id);
        el.textContent = text;
        if (text) {
          setTimeout(() => {
            if (el.textContent === text) el.textContent = "";
          }, 2000);
        }
      }

      function setHint(id, text) {
        const el = document.getElementById(id);
        el.textContent = text;
        if (text) {
          setTimeout(() => {
            if (el.textContent === text) el.textContent = "";
          }, 1500);
        }
      }

      function saveRunEvidence() {
        const text = document.getElementById("runEvidence").value;
        if (!text.trim()) return;
        localStorage.setItem("runEvidence", text);
        setStatus("runEvidenceSaved", "saved");
      }

      function loadRunEvidence() {
        const text = localStorage.getItem("runEvidence");
        if (text) {
          document.getElementById("runEvidence").value = text;
          setStatus("runEvidenceSaved", "loaded");
        }
      }

      function autoFillRunEvidence() {
        const text = localStorage.getItem("runEvidence");
        if (text && !document.getElementById("runEvidence").value) {
          document.getElementById("runEvidence").value = text;
          setStatus("runEvidenceSaved", "auto");
        }
      }

      function saveRunLifi() {
        const text = document.getElementById("runLifi").value;
        if (!text.trim()) return;
        localStorage.setItem("runLifi", text);
        setStatus("runLifiSaved", "saved");
      }

      function loadRunLifi() {
        const text = localStorage.getItem("runLifi");
        if (text) {
          document.getElementById("runLifi").value = text;
          setStatus("runLifiSaved", "loaded");
        }
      }

      function autoFillRunLifi() {
        const text = localStorage.getItem("runLifi");
        if (text && !document.getElementById("runLifi").value) {
          document.getElementById("runLifi").value = text;
          setStatus("runLifiSaved", "auto");
        }
      }

      function autoFillRunLifi() {
        const text = localStorage.getItem("runLifi");
        if (text && !document.getElementById("runLifi").value) {
          document.getElementById("runLifi").value = text;
        }
      }

      function saveRiskTemplate() {
        const text = document.getElementById("risk").value;
        if (!text.trim()) return;
        localStorage.setItem("riskTemplate", text);
      }

      function loadRiskTemplate() {
        const text = localStorage.getItem("riskTemplate");
        if (text) {
          document.getElementById("risk").value = text;
        }
      }

      function formatRiskJson() {
        const textarea = document.getElementById("risk");
        if (!textarea.value.trim()) return;
        try {
          textarea.value = JSON.stringify(JSON.parse(textarea.value), null, 2);
        } catch (error) {
          document.getElementById("createResult").textContent = `Risk JSON invalid: ${error.message || error}`;
        }
      }

      function collectParamFields() {
        const container = document.getElementById("paramFields");
        const params = {};
        const errors = [];
        const templateName = document.getElementById("template").value;
        const template = templateCache.find((item) => item.template === templateName);
        const required = template ? template.requiredParams || [] : [];
        const optional = template ? template.optionalParams || [] : [];
        container.querySelectorAll("input[data-param]").forEach((input) => {
          if (!input.value) {
            if (required.includes(input.dataset.param)) {
              input.style.borderColor = "red";
              errors.push(`${input.dataset.param} is required`);
            } else if (optional.includes(input.dataset.param)) {
              input.style.borderColor = "";
            }
            return;
          }
          const type = input.dataset.paramType || "string";
          input.style.borderColor = "";
          if (type === "number") {
            const parsed = Number(input.value);
            if (!Number.isFinite(parsed)) {
              input.style.borderColor = "red";
              errors.push(`${input.dataset.param} must be a number`);
              return;
            }
            params[input.dataset.param] = parsed;
            return;
          }
          if (type === "decimal") {
            const parsed = Number(input.value);
            if (!Number.isFinite(parsed)) {
              input.style.borderColor = "red";
              errors.push(`${input.dataset.param} must be a decimal`);
              return;
            }
            params[input.dataset.param] = String(parsed);
            return;
          }
          if (type === "address") {
            if (!/^0x[a-fA-F0-9]{40}$/.test(input.value)) {
              input.style.borderColor = "red";
              errors.push(`${input.dataset.param} must be a 0x address`);
              return;
            }
          }
          params[input.dataset.param] = input.value;
        });
        if (errors.length) {
          document.getElementById("createResult").textContent = errors.join("\n");
          return null;
        }
        return params;
      }

      async function createStrategy() {
        const intentText = document.getElementById("intentText").value;
        const template = document.getElementById("template").value;
        const paramsText = document.getElementById("params").value;
        const riskText = document.getElementById("risk").value;
        const params = collectParamFields();
        if (!params) {
          document.getElementById("createResult").textContent = "Param validation failed.";
          return;
        }
        if (paramsText.trim()) {
          try {
            Object.assign(params, JSON.parse(paramsText));
          } catch (error) {
            document.getElementById("createResult").textContent = `Params JSON invalid: ${error.message || error}`;
            return;
          }
        }
        let risk = undefined;
        if (riskText.trim()) {
          try {
            risk = JSON.parse(riskText);
          } catch (error) {
            document.getElementById("createResult").textContent = `Risk JSON invalid: ${error.message || error}`;
            return;
          }
        }
        const res = await apiFetch("/api/strategies", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ intentText, template: template || undefined, params, risk }),
        });
        const data = await res.json();
        document.getElementById("createResult").textContent = JSON.stringify(data, null, 2);
        if (data.strategy && data.strategy.id) {
          document.getElementById("runStrategyId").value = data.strategy.id;
          window.latestStrategyId = data.strategy.id;
        }
        localStorage.setItem("lastStrategyParams", JSON.stringify({ intentText, template, params, risk }));
        localStorage.setItem("paramsTemplate", JSON.stringify(params));
        localStorage.setItem("lastTemplateSelect", template || "");
        if (document.getElementById("autoSaveRisk").checked && riskText.trim()) {
          try {
            JSON.parse(riskText);
            localStorage.setItem("riskTemplate", riskText);
          } catch (error) {
            document.getElementById("createResult").textContent = `Risk auto-save failed: ${error.message || error}`;
          }
        }
        await loadStrategies();
      }

      function fillLatestStrategyId() {
        if (window.latestStrategyId) {
          document.getElementById("runStrategyId").value = window.latestStrategyId;
        }
      }

      function focusFirstRequired() {
        const input = document.querySelector("input[data-param-required='true']");
        if (input) input.focus();
      }

      function loadLastStrategyParams() {
        const raw = localStorage.getItem("lastStrategyParams");
        if (!raw) return;
        const saved = JSON.parse(raw);
        document.getElementById("intentText").value = saved.intentText || "";
        document.getElementById("template").value = saved.template || "";
        document.getElementById("templateSelect").value = saved.template || "";
        document.getElementById("params").value = JSON.stringify(saved.params || {}, null, 2);
        document.getElementById("risk").value = JSON.stringify(saved.risk || {}, null, 2);
        renderParamFields(saved.template || "");
      }

      function saveFormSnapshot() {
        const snapshot = {
          intentText: document.getElementById("intentText").value,
          template: document.getElementById("template").value,
          params: collectParamFields() || {},
          risk: (() => {
            try {
              return JSON.parse(document.getElementById("risk").value || "{}");
            } catch {
              return {};
            }
          })(),
        };
        localStorage.setItem("formSnapshot", JSON.stringify(snapshot));
      }

      function loadFormSnapshot() {
        const raw = localStorage.getItem("formSnapshot");
        if (!raw) return;
        const saved = JSON.parse(raw);
        document.getElementById("intentText").value = saved.intentText || "";
        document.getElementById("template").value = saved.template || "";
        document.getElementById("templateSelect").value = saved.template || "";
        document.getElementById("risk").value = JSON.stringify(saved.risk || {}, null, 2);
        renderParamFields(saved.template || "");
        document.getElementById("params").value = JSON.stringify(saved.params || {}, null, 2);
        const paramsTemplate = localStorage.getItem("paramsTemplate");
        if (paramsTemplate) {
          try {
            const parsed = JSON.parse(paramsTemplate);
            document.querySelectorAll("input[data-param]").forEach((input) => {
              if (parsed[input.dataset.param]) {
                input.value = parsed[input.dataset.param];
              }
            });
          } catch {
            // ignore
          }
        }
      }

      function fillEvidenceTemplate() {
        const templateName = document.getElementById("template").value;
        const template = templateCache.find((item) => item.template === templateName);
        if (!template) return;
        const evidence = {
          template: template.template,
          templateParams: collectParamFields() || {},
        };
        document.getElementById("runEvidence").value = JSON.stringify(evidence, null, 2);
        window.latestEvidenceTemplate = evidence;
      }

      function setRunResult(message, status) {
        const el = document.getElementById("runResult");
        el.textContent = message;
        el.classList.remove("status-ok", "status-error");
        if (status === "ok") el.classList.add("status-ok");
        if (status === "error") el.classList.add("status-error");
        saveRunResultState(message, status);
        if (message && !document.getElementById("keepRunResult").checked) {
          setTimeout(() => {
            if (el.textContent === message) {
              clearRunResult();
            }
          }, 4000);
        }
      }

      async function runStrategyNow() {
        const strategyId = document.getElementById("runStrategyId").value;
        const mode = document.getElementById("runMode").value || "plan";
        const evidenceText = document.getElementById("runEvidence").value;
        const lifiText = document.getElementById("runLifi").value;
        let evidence = undefined;
        if (evidenceText.trim()) {
          try {
            evidence = JSON.parse(evidenceText);
          } catch (error) {
            setRunResult(`Evidence JSON invalid: ${error.message || error}`, "error");
            return;
          }
        }
        let lifiResult = undefined;
        if (lifiText.trim()) {
          try {
            lifiResult = JSON.parse(lifiText);
          } catch (error) {
            setRunResult(`LIFI JSON invalid: ${error.message || error}`, "error");
            return;
          }
        }
        const res = await apiFetch(`/api/strategies/${strategyId}/run`, {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ mode, evidence, lifiResult }),
        });
        const data = await res.json();
        if (data.status && data.status !== "ok") {
          setRunResult(`Run failed: ${JSON.stringify(data, null, 2)}`, "error");
        } else {
          setRunResult(JSON.stringify(data, null, 2), "ok");
        }
        if (lifiText.trim()) {
          localStorage.setItem("runLifi", lifiText);
          autoFillRunLifi();
        }
        if (evidenceText.trim()) {
          localStorage.setItem("runEvidence", evidenceText);
          autoFillRunEvidence();
        }
        await loadExecutions();
      }

      function loadMoreExecutions() {
        summaryLimit += 10;
        loadExecutions();
      }

      loadApiBaseUrl();
      autoDetectApiBaseUrl();
      checkNodeApi();
      refreshApiInfo();
      loadStrategies();
      loadTemplates();
      loadSummaryFilters();
      loadSummaryPrefs();
      loadExecutions();
      attachSummaryFilterListeners();
      autoFillRunEvidence();
      autoFillRunLifi();
      loadKeepRunResult();
      loadExecutionHighlightsVisibility();
      loadRunResultState();
      loadApiAutoRefresh();
      loadApiHealthErrorsVisibility();
      loadApiSettingsVisibility();
      loadApiBaseHistory();
    </script>
  </body>
</html>
